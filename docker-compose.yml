# This file is part of Argos.

# Copyright (C) 2025 Andr√©s Lillo Ortiz

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.

services:
  # 1. INGESTION: Apache NiFi
  nifi:
    image: apache/nifi:latest
    container_name: argos_nifi
    ports:
      - "8443:8443" # NiFi UI (HTTPS)
    environment:
      - NIFI_WEB_HTTP_HOST=0.0.0.0
      - SINGLE_USER_CREDENTIALS_USERNAME=admin
      - SINGLE_USER_CREDENTIALS_PASSWORD=Password123! # Demo password
    volumes:
      - ./data_lake:/opt/shared_data
    networks:
      - argos_net

  # 2. STORAGE: ClickHouse
  clickhouse:
    image: clickhouse/clickhouse-server
    container_name: argos_clickhouse
    ports:
      - "8123:8123" # HTTP Port (for Grafana and Spark JDBC)
      - "9000:9000" # Native Port
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    volumes:
      - ./clickhouse_data:/var/lib/clickhouse
    networks:
      - argos_net

  # 3a. PROCESSING: Apache Spark (Master)
  spark-master:
    image: apache/spark:latest
    container_name: argos_spark_master
    hostname: spark-master
    command: /opt/spark/bin/spark-class org.apache.spark.deploy.master.Master
    environment:
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
    ports:
      - "8080:8080" # Master UI
      - "7077:7077" # Connection port
    volumes:
      - ./data_lake:/opt/shared_data
    networks:
      - argos_net

  # 3b. PROCESSING: Apache Spark (Worker)
  spark-worker:
    image: apache/spark:latest
    container_name: argos_spark_worker
    command: /opt/spark/bin/spark-class org.apache.spark.deploy.worker.Worker spark://spark-master:7077
    environment:
      - SPARK_WORKER_MEMORY=1G
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_SSL_ENABLED=no
    depends_on:
      - spark-master
    volumes:
      - ./data_lake:/opt/shared_data
    networks:
      - argos_net

  # 4. VISUALIZATION: Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: argos_grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - clickhouse
    networks:
      - argos_net

networks:
  argos_net:
    driver: bridge
