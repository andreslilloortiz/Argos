# This file is part of Argos.

# Copyright (C) 2025 Andr√©s Lillo Ortiz

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.

# Demo password: Password123!

# 0. UTILITY: Permission Fixer (The "Janitor")
services:
  # This transient container fixes ownership permissions on the shared volume
  # so both NiFi (UID 1000) and Spark (UID 185) can read/write without errors.
  init-permissions:
    image: busybox
    container_name: argos_permissions
    command: sh -c "chown -R 1000:1000 /opt/shared_data && chmod -R 777 /opt/shared_data"
    volumes:
      - data_lake:/opt/shared_data

  # 1. INGESTION: Apache NiFi
  nifi:
    image: apache/nifi:latest
    container_name: argos_nifi
    ports:
      - "8443:8443" # NiFi UI (HTTPS)
    environment:
      - NIFI_WEB_HTTP_HOST=0.0.0.0
      - SINGLE_USER_CREDENTIALS_USERNAME=admin
      - SINGLE_USER_CREDENTIALS_PASSWORD=Password123!
    volumes:
      - data_lake:/opt/shared_data
      - nifi_conf:/opt/nifi/nifi-current/conf
      - nifi_database:/opt/nifi/nifi-current/database_repository
      - nifi_flowfile:/opt/nifi/nifi-current/flowfile_repository
      - nifi_content:/opt/nifi/nifi-current/content_repository
      - nifi_provenance:/opt/nifi/nifi-current/provenance_repository
    depends_on:
      init-permissions:
        condition: service_completed_successfully
    networks:
      - argos_net

  # 2. STORAGE: ClickHouse
  clickhouse:
    image: clickhouse/clickhouse-server
    container_name: argos_clickhouse
    ports:
      - "8123:8123" # HTTP Port (for Grafana and Spark JDBC)
      - "9000:9000" # Native Port
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    environment:
      - CLICKHOUSE_DB=argos
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=Password123!
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql # Automatize DB creation
    networks:
      - argos_net

  # 3a. PROCESSING: Apache Spark (Master)
  spark-master:
    image: apache/spark:latest
    container_name: argos_spark_master
    hostname: spark-master
    command: /opt/spark/bin/spark-class org.apache.spark.deploy.master.Master
    environment:
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
    ports:
      - "8080:8080" # Master UI
      - "7077:7077" # Connection port
    volumes:
      - data_lake:/opt/shared_data
      - ./jars/clickhouse-jdbc-0.9.4-all.jar:/opt/spark/jars/clickhouse-jdbc.jar
      - ./etl/etl_job.py:/opt/spark_scripts/etl_job.py
      - spark_checkpoints:/opt/spark_checkpoints
    networks:
      - argos_net

  # 3b. PROCESSING: Apache Spark (Worker)
  spark-worker:
    image: apache/spark:latest
    container_name: argos_spark_worker
    command: /opt/spark/bin/spark-class org.apache.spark.deploy.worker.Worker spark://spark-master:7077
    environment:
      - SPARK_WORKER_MEMORY=1G
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_SSL_ENABLED=no
    depends_on:
      - spark-master
    volumes:
      - data_lake:/opt/shared_data
      - ./jars/clickhouse-jdbc-0.9.4-all.jar:/opt/spark/jars/clickhouse-jdbc.jar
      - ./etl/etl_job.py:/opt/spark_scripts/etl_job.py
      - spark_checkpoints:/opt/spark_checkpoints
    networks:
      - argos_net

  # 4. VISUALIZATION: Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: argos_grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=Password123!
      - GF_INSTALL_PLUGINS=grafana-clickhouse-datasource
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - clickhouse
    networks:
      - argos_net

networks:
  argos_net:
    driver: bridge

volumes:
  nifi_conf:
  nifi_database:
  nifi_flowfile:
  nifi_content:
  nifi_provenance:
  clickhouse_data:
  data_lake:
  spark_checkpoints:
  grafana_data:
